<template>
    <div class="page" data-name="inspectuser">
        <div class="grid">
            <div class="editprofilebox box">
                <div class="psettings boxtitle">Konto Informationer</div>
                <div style="width: 90%;margin-left:5%;">
                    <input class="iu_id" style="display:none;">
                    <div class="inputfieldtitle">Fornavn</div>
                    <input class="inputfield iu_fname" type="text" name="fname">

                    <div class="inputfieldtitle">Efternavn</div>
                    <input class="inputfield iu_lname" type="text" name="lname">

                    <div class="inputfieldtitle">Email</div>
                    <input class="inputfield iu_email" type="text" name="email">

                    <div class="inputfieldtitle">Kort</div>
                    <input class="inputfield iu_card" type="text" name="email">

                    <div style="margin-top:15px;">
                            <div class="inputfieldtitle" style="margin:0;">Område</div>
                            <select class="selectedfile inputfield areaDropDown" style="margin:0;">
                            </select>
                        </div>

                    <div class="inputfield" style="width:fit-content!important;margin-top:25px;max-width:180px!important;">
                        <label for="iu_isAdmin" class="noSelect">Administrator konto</label>
                        <input type="checkbox" class="iu_isAdmin" id="iu_isAdmin" style="height:20px;width:20px;vertical-align: middle;">
                    </div>
                    <div class="inputfield" style="width:fit-content!important;margin-top:25px;max-width:180px!important;">
                        <label for="iu_isInstructor" class="noSelect">Instruktør konto</label>
                        <input type="checkbox" id="iu_isInstructor" class="iu_isInstructor"
                            style="height:20px;width:20px;vertical-align: middle;">
                    </div>
                    
                </div>
                <div class="btnbox" style="margin-top:-37px;">
                    <div style="display: inline-block;">
                        <a @click="updateUser" class="newbtnstyle noSelect">Opdater konto</a>
                    </div>
                </div>
            </div>

            <div class="editprofilebox box goright" style="height: 275px;">
                <div class="upassword boxtitle">Opdater Adgangskode</div>
                <div style="width: 90%;margin-left:5%;">

                    <div class="inputfieldtitle">Ny adgangskode</div>
                    <input class="inputfield iu_newPass" type="password" id="iu_newPass" name="newPass">

                    <div class="inputfieldtitle">Bekræft adgangskode</div>
                    <input class="inputfield iu_confPass" type="password" id="iu_confPass" name="confPass">
                </div>
                <div class="btnbox" style="margin-top:25px;">
                    <div style="display: inline-block;">
                        <a @click="updateUserPassword" class="newbtnstyle noSelect">Opdater adgangskode</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>


<script>
    var inspectedUser;
    return {

        /**
         * Det datasæt som framework bruger internt i dette view, de kan ikke tilgås udefra.
         */
        data: function () {
            return {
            };
        },

        // Framework7 Component Methods
        methods: {
            fillAccountInformation: function () {
                app.request.getJSON(`${app.data['serverIP']}endpoints/web/getUser.php?userID=${inspectedUser}`, {}, function (response) {
                    if (response.result == 1) {
                        $$('.iu_fname').val(`${response.users[0].firstName}`);
                        $$('.iu_lname').val(`${response.users[0].lastName}`);
                        $$('.iu_email').val(`${response.users[0].email}`);
                        $$('.iu_card').val(`${response.users[0].cardID}`);
                        $$('.areaDropDown').val(response.users[0].areaID)
                        $$('.iu_id').val(response.users[0].ID);
                        if(response.users[0].isAdmin == 1){
                            $$('.iu_isAdmin').prop('checked', true);
                        }
                        if(response.users[0].isInstructor == 1){
                            $$('.iu_isInstructor').prop('checked', true);
                        }

                    }
                }, function (e, e2) { console.error(e); console.error(e2) });
            },
            fillAreaDropDown: function () {
                that = this;
                app.request.getJSON(`${app.data['serverIP']}endpoints/web/getAreas.php?userID=${app.data['userID']}&token=${app.data['token']}`, {}, function (response) {
                    if (response.result == 1) {
                        let innerHTML = "";
                        Object.keys(response.records).forEach((key, index) => {
                            let value = response.records[key];
                            innerHTML +=
                                `
                                <option value="${value.ID}">${value.Area} - ${value.Instructor}</option>
                                `;
                        });
                        $$('.areaDropDown').html(innerHTML);
                        that.fillAccountInformation();
                    }
                }, function (e, e2) { console.error(e); console.error(e2) });
            },
            updateUser: function () {
                let ID = $$('.iu_id').val();
                let firstName = $$('.iu_fname').val();
                let lastName = $$('.iu_lname').val();
                let email = $$('.iu_email').val();
                let userGroup = $$('.areaDropDown').val();
                let cardID = $$('.iu_card').val();
                let isAdmin = 0;
                let isInstructor = 0;
                if ($$('.iu_isAdmin').prop('checked') == true) {
                    isAdmin = 1;
                }
                if ($$('.iu_isInstructor').prop('checked') == true) {
                    isInstructor = 1;
                }
                if (firstName == "" || lastName == "" || email == "" || userGroup == "" || cardID == "") {
                    app.methods.statusMsg("Alle felter skal være udfyldt", "error", ".psettings");
                    return;
                }
                if (ID == "") {
                    app.methods.statusMsg("Noget gik galt", "error", ".psettings");
                    return;
                }

                app.request.post(`${app.data['serverIP']}endpoints/web/postUpdateUser.php`, {
                    updateUserID: ID,
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    userGroup: userGroup,
                    cardID: cardID,
                    isAdmin: isAdmin,
                    isInstructor: isInstructor,
                    token: app.data['token'],
                    userID: app.data['userID'],
                }, function (response) {
                    if (response.result == 0) {
                        app.methods.statusMsg(response.message, "error", ".psettings");
                        return;
                    } else {
                        app.methods.statusMsg(response.message, "success", ".psettings");
                        setTimeout(function () { app.views.main.router.navigate("/usergrouplist/", { reloadCurrent: true, }) }, 3000);

                    }
                }, function (e, e2) { console.error(e); console.error(e2) }, "json");
            },
            updateUserPassword: function () {
                let ID = $$('.iu_id').val();
                let password = $$('.iu_newPass').val();
                let confPassword = $$('.iu_confPass').val();

                if (password == "" || confPassword == "") {
                    app.methods.statusMsg("Alle felter skal være udfyldt", "error", ".upassword");
                    return;
                }
                if (password != confPassword) {
                    app.methods.statusMsg("Adgangskoderne skal matche", "error", ".upassword");
                    return;
                }
                if (ID == "") {
                    app.methods.statusMsg("Noget gik galt", "error", ".upassword");
                    return;
                }

                app.request.post(`${app.data['serverIP']}endpoints/web/postUpdateUserPassword.php`, {
                    updateUserID: ID,
                    password: password,
                    token: app.data['token'],
                    userID: app.data['userID'],
                }, function (response) {
                    if (response.result == 0) {
                        app.methods.statusMsg(response.message, "error", ".upassword");
                        return;
                    } else {
                        app.methods.statusMsg(response.message, "success", ".upassword");
                        setTimeout(function () { app.views.main.router.navigate("/usergrouplist/", { reloadCurrent: true, }) }, 3000);

                    }
                }, function (e, e2) { console.error(e); console.error(e2) }, "json");
            },
        },
        on: {
            //pageMounted trigger når siden bliver insat i DOMen
            pageMounted: function (page) {
                inspectedUser = page.detail.route.params.userID;
                this.fillAreaDropDown();
            },
        },
    }


</script>