<template>
    <div class="page" data-name="currentDay">
        <div class="bottombox box">
            <div class="box" style="margin: 35px;">
                <div class="boxtitle">Uge <span class="currentWeek"></span></div>
                <div class="bottombox testbox" style="overflow-y:auto;overflow-x:hidden;max-height:250px;">
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: center;">Dag</th>
                                <th style="text-align: center;">Check ind</th>
                                <th style="text-align: center;">Check ud</th>
                                <th style="text-align: center;">Rest</th>
                            </tr>
                        </thead>
                        <tbody class="ugeBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    var timer;
    return {

        /**
         * Det datasæt som framework bruger internt i dette view, de kan ikke tilgås udefra.
         */
        data: function () {
            return {
            };
        },

        // Framework7 Component Methods
        methods: {
            fillTable: function () {
                app.request.getJSON(`${app.data['serverIP']}endpoints/web/getCurrentWeekPerUser.php?userID=${app.data['userID']}&token=${app.data['token']}`, {}, function (response) {
                    if (response.result == 1) {
                        $$('.currentWeek').html(response.currentWeek);
                        let innerHTML = "";
                        Object.keys(response.records[0]).map((key, index)=>{
                            if(response.records[0][key]){
                                let checkin = moment(response.records[0][key].in, "LTS");
                                let event;
                                if(key == "Friday"){
                                    event = checkin.add(5, 'hours').unix();
                                }else{
                                    event = checkin.add(8, 'hours').unix();
                                }
                                let currentTime;
                                
                                if(response.records[0][key].out != ""){
                                    currentTime = moment(response.records[0][key].out, "LTS").unix();
                                }else{
                                    currentTime = moment().unix();
                                }
                                
                                let diffTime = event - currentTime;
                                let duration = moment.duration(diffTime * 1000, 'milliseconds');
                                let hours = moment.duration(duration).hours().toString();
                                let min = moment.duration(duration).minutes().toString();
                                if(hours.length == 1) hours = '0'+hours;
                                if(min.length == 1) min = '0'+min;
                                if(hours <= 0)hours = "00";
                                if(min <= 0)min = "00";
                    
                                if(key == response.currentDay && response.records[0][key].out == ""){
                                    timer = setInterval(function(){
                                        currentTime = moment().unix();
                                        diffTime = event - currentTime;
                                        duration = moment.duration(diffTime * 1000, 'milliseconds');
                                        hours = moment.duration(duration).hours().toString();
                                        min = moment.duration(duration).minutes().toString();
                                        if(hours.length == 1) hours = '0'+hours;
                                        if(min.length == 1) min = '0'+min;
                                        $$('.currDay').html(hours+":"+min);
                                    }, 1000);
                                }

                                let test = response.records[0][key].in - response.records[0][key].out;
                                innerHTML +=
                                `
                                <tr>
                                    <td style="text-align:center;">${key}</td>
                                    <td style="text-align:center;">${response.records[0][key].in}</td>
                                    <td style="text-align:center;">${response.records[0][key].out}</td>
                                    <td style="text-align:center;"${key==response.currentDay ? 'class="currDay"': ""}>${hours+":"+min}</td>
                                </tr>
                                `;
                            }else{
                                innerHTML +=
                                `
                                <tr>
                                    <td style="text-align:center;">${key}</td>
                                    <td style="text-align:center;"> </td>
                                    <td style="text-align:center;"> </td>
                                    <td style="text-align:center;"> </td>
                                </tr>
                                `;
                            }
                        })
                        $$('.ugeBody').html(innerHTML);
                    }
                });
            },

        },
        on: {
            //pageMounted trigger når siden bliver insat i DOMen
            pageMounted: function (page) {
                this.fillTable();
                clearInterval(timer);
            },
            pageAfterOut: function (page) {
                clearInterval(timer);
            }
        },
    }


</script>